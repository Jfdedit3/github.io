<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bsky Post Viewer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --card: #1a1a1a;
      --text: #e0e0e0;
      --subtle: #888;
      --primary: #00aaff;
      --radius: 16px;
      --gap: 16px;
      --font: "Inter", system-ui, sans-serif;
      --border-color: #2a2a2a;
      --shadow-light: rgba(0, 0, 0, 0.2);
      --shadow-dark: rgba(0, 0, 0, 0.4);
    }

    :root[data-theme="light"] {
      --bg: #f5f5f5;
      --card: #ffffff;
      --text: #111;
      --subtle: #777;
      --primary: #0077ff;
      --border-color: #e0e0e0;
      --shadow-light: rgba(0, 0, 0, 0.1);
      --shadow-dark: rgba(0, 0, 0, 0.2);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 40px 20px;
      min-height: 100vh;
      transition: background 0.3s ease;
    }

    .container {
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }

    .header { text-align: center; margin-bottom: 8px; }
    .logo { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .logo svg { width: 28px; height: 28px; color: var(--primary); }
    h1 { font-size: 22px; font-weight: 700; }
    .subtitle { font-size: 15px; color: var(--subtle); margin-top: 4px; }

    .input-wrapper { position: relative; }
    input {
      width: 100%;
      padding: 12px 36px 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 14px;
      background: var(--card);
      color: var(--text);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 1px 3px var(--shadow-light);
    }
    input:focus { outline: none; border-color: var(--primary); background: var(--card); box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.3), inset 0 1px 3px var(--shadow-light); }
    input:focus-visible { outline: none; border-color: var(--primary); background: var(--card); box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.3), inset 0 1px 3px var(--shadow-light); }
    .clear-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none; border: none; font-size: 16px; cursor: pointer;
      color: var(--subtle);
      transition: all 0.2s ease;
      padding: 4px;
    }
    .clear-btn:hover {
      transform: translateY(-50%) scale(1.1);
      color: var(--primary);
    }
    .hint { font-size: 12px; color: var(--subtle); margin-top: 4px; }

    .post-card, .input-container, .history-container {
      background: var(--card);
      border-radius: var(--radius);
      padding: var(--gap);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 15px var(--shadow-dark);
      animation: fadeInUp 0.6s ease-out;
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease, border-color 0.3s ease;
    }
    .post-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 170, 255, 0.4);
    }
    .post-header { display: flex; align-items: center; gap: 12px; }
    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--primary); 
      color: #000;
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-weight: 600; 
      font-size: 16px;
      overflow: hidden;
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }
    .avatar:hover {
      transform: scale(1.08);
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .avatar a { color: inherit; text-decoration: none; display:block; width:100%; height:100%; }
    .post-info { flex: 1; min-width: 0; }
    .display-name { font-weight: 600; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .handle { font-size: 13px; color: var(--subtle); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .post-time { font-size: 12px; color: var(--subtle); flex-shrink: 0; }

    .post-content { font-size: 15px; line-height: 1.6; margin-top: 8px; word-break: break-word; }
    .post-content a { color: var(--primary); text-decoration: none; }
    .post-content a:hover { text-decoration: underline; }

    .post-media { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
      gap: 12px;
      margin-top: 12px;
    }
    .post-media img, .post-media video { 
      width: 100%; 
      height: 100%; 
      max-height: 400px;
      object-fit: cover; 
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.3s ease, filter 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 2px 8px var(--shadow-light);
    }
    .post-media img:hover {
      transform: scale(1.01);
      filter: brightness(1.05);
      box-shadow: 0 4px 12px var(--shadow-dark);
    }

    @media (max-width: 768px) {
      .post-media {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .post-media img, .post-media video {
        min-height: 200px;
        max-height: 350px;
        border-radius: 12px;
      }
      
      .post-media img:hover {
        transform: scale(1.01);
      }
    }

    @media (max-width: 480px) {
      body { padding: 20px 15px; }
      .container { gap: 12px; }
      .post-card, .input-container, .history-container { padding: 15px; border-radius: 12px; }
      .avatar { width: 40px; height: 40px; font-size: 14px; }
      .display-name { font-size: 14px; }
      .handle { font-size: 12px; }
      .post-content { font-size: 14px; }
      .post-media img, .post-media video {
        min-height: 180px;
        max-height: 300px;
      }
    }

    .post-stats { 
      display: flex; gap: 20px; font-size: 13px; margin-top: 12px; 
      border-top: 1px solid var(--border-color); 
      padding-top: 12px;
    }
    .stat { 
      display: flex; align-items: center; gap: 6px; 
      color: var(--subtle); cursor: pointer;
      transition: color 0.3s ease, transform 0.2s ease;
    }
    .stat:hover {
      color: var(--primary);
      transform: translateY(-1px);
    }
    .stat svg { width: 18px; height: 18px; fill: currentColor; }

    .loading, .error-message { text-align: center; font-size: 14px; margin-top: 8px; padding: 10px; }
    .hidden { display: none; }

    .history-container {
      margin-top: var(--gap);
      animation: fadeIn 0.5s ease-out forwards;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .history-header h3 {
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
    }

    .clear-history-btn {
      background: none;
      border: none;
      color: var(--subtle);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
      transition: color 0.2s ease, transform 0.2s ease;
    }

    .clear-history-btn:hover {
      color: var(--primary);
      transform: rotate(90deg);
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      border: 1px solid transparent;
      animation: slideInRight 0.4s ease-out;
      animation-fill-mode: both;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }

    .history-item + .history-item {
      margin-top: 8px;
    }

    .history-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--border-color);
      transform: translateY(-1px);
    }
    
    :root[data-theme="light"] .history-item:hover {
      background: rgba(0, 0, 0, 0.03);
    }

    .history-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 1px 4px var(--shadow-light);
    }

    .history-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .history-avatar-fallback {
      display: none;
      width: 100%;
      height: 100%;
      align-items: center;
      justify-content: center;
    }
    .history-avatar img + .history-avatar-fallback { display: none !important; }

    .history-content {
      flex: 1;
      min-width: 0;
    }

    .history-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .history-handle {
      font-size: 12px;
      color: var(--subtle);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .history-text {
      font-size: 13px;
      color: var(--text);
      margin-top: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .loading-spinner {
      width: 28px;
      height: 28px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
      cursor: zoom-out;
    }

    .modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: var(--radius);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
      animation: zoomIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      object-fit: contain;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes zoomIn {
      from { transform: scale(0.7); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .shimmer {
      background: linear-gradient(90deg, var(--card) 0%, #2a2a2a 50%, var(--card) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius);
      overflow: hidden;
    }
    :root[data-theme="light"] .shimmer {
        background: linear-gradient(90deg, #f0f0f0 0%, #e0e0e0 50%, #f0f0f0 100%);
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* Shimmer placeholder styles */
    .shimmer-placeholder {
      background-color: var(--border-color);
      border-radius: 4px;
    }
    .shimmer-post-card {
      padding: var(--gap);
      display: flex;
      flex-direction: column;
      gap: var(--gap);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      box-shadow: 0 4px 15px var(--shadow-dark);
    }
    .shimmer-header { display: flex; align-items: center; gap: 12px; }
    .shimmer-avatar { width: 44px; height: 44px; border-radius: 50%; background-color: var(--border-color); }
    .shimmer-info { flex: 1; display: flex; flex-direction: column; gap: 6px; }
    .shimmer-name { height: 16px; width: 70%; background-color: var(--border-color); }
    .shimmer-handle { height: 14px; width: 50%; background-color: var(--border-color); }
    .shimmer-content { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
    .shimmer-line { height: 14px; background-color: var(--border-color); }
    .shimmer-line:nth-child(1) { width: 95%; }
    .shimmer-line:nth-child(2) { width: 98%; }
    .shimmer-line:nth-child(3) { width: 80%; }
    .shimmer-media { 
      display: grid; 
      grid-template-columns: repeat(2, 1fr); 
      gap: 12px; 
      margin-top: 12px;
      height: 150px;
    }
    .shimmer-media-item { background-color: var(--border-color); border-radius: 12px; }
    .shimmer-stats { 
      display: flex; gap: 20px; margin-top: 12px; 
      border-top: 1px solid var(--border-color); padding-top: 12px;
    }
    .shimmer-stat { height: 16px; width: 60px; background-color: var(--border-color); }

    .actions {
      display: flex; gap: 8px; margin-top: 16px;
      justify-content: flex-end;
    }

    .btn { 
      padding: 10px 16px;
      border: 1px solid var(--border-color); 
      border-radius: 12px;
      background: var(--card);
      color: var(--text); 
      cursor:pointer; 
      font: 500 14px var(--font);
      transition: transform .15s ease, background .2s, border-color .2s, box-shadow .2s; 
      box-shadow: 0 2px 5px var(--shadow-light);
    }
    .btn:hover { 
      transform: translateY(-2px); 
      background: #252525;
      border-color: var(--primary);
      box-shadow: 0 4px 10px var(--shadow-dark);
    }
    :root[data-theme="light"] .btn:hover {
      background: #e9e9e9;
    }
    .btn:focus-visible { 
      outline: none; 
      border-color: var(--primary); 
      box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.3);
    }
    .btn-primary { 
      background: var(--primary); 
      color: #fff; 
      border-color: transparent; 
      box-shadow: 0 2px 5px rgba(0, 170, 255, 0.4);
    }
    .btn-primary:hover {
      background: var(--primary);
      filter: brightness(1.1);
      box-shadow: 0 4px 10px rgba(0, 170, 255, 0.6);
      border-color: transparent;
    }
    .btn.icon { 
      width: 44px;
      height: 44px;
      padding: 0;
      display:flex; align-items:center; justify-content:center; 
      font-size: 20px;
    }
    .btn.icon:hover { transform: translateY(-1px); }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .input-container {
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2L2 7v10c0 5.55 3.84 10 9 11 1.16-.21 2.27-.62 3.3-1.21.5-.29.96-.63 1.38-1.03.42-.48.8-.84 1.12-1.32.32-.48.6-1.08.82-1.54.22-.54.38-1.1.48-1.68.1-.58.14-1.18.14-1.79V7L12 2z"/>
        </svg>
        <h1>Bluesky Post Viewer</h1>
      </div>
      <p class="subtitle">View any Bluesky post in a beautiful, interactive format</p>
    </div>

    <div class="input-container">
      <div class="input-wrapper">
        <input 
          type="text" 
          id="postUrl" 
          placeholder="Paste Bluesky post URL..."
          autocomplete="off"
        >
        <button id="clearBtn" class="clear-btn hidden" aria-label="Clear input">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="input-hints">
        <span class="hint">💡 Tip: Copy URL from bsky.app and paste here</span>
      </div>
      <div class="actions">
        <button id="pasteBtn" class="btn">Paste</button>
        <button id="openBtn" class="btn btn-primary">Open in Bluesky</button>
        <button id="themeToggle" class="btn icon" aria-label="Toggle theme">
          <span id="themeIcon">🌓</span>
        </button>
      </div>
    </div>

    <div id="output" class="output-container"></div>
    
    <div id="loading" class="loading hidden">
      <div class="loading-spinner"></div>
      <p>Loading post...</p>
    </div>

    <div id="error" class="error-message hidden"></div>
  </div>

  <script>
    class BlueskyViewer {
      constructor() {
        this.postUrl = document.getElementById('postUrl');
        this.output = document.getElementById('output');
        this.loading = document.getElementById('loading');
        this.error = document.getElementById('error');
        this.clearBtn = document.getElementById('clearBtn');
        this.pasteBtn = document.getElementById('pasteBtn');
        this.openBtn = document.getElementById('openBtn');
        this.themeToggle = document.getElementById('themeToggle');
        this.themeIcon = document.getElementById('themeIcon');
        
        this.debounceTimer = null;
        this.maxHistory = 10;
        this.historyKey = 'bskyHistory';
        this.init();
      }

      async init() {
        this.postUrl.addEventListener('input', () => this.handleInput());
        this.clearBtn.addEventListener('click', () => this.clearInput());
        this.pasteBtn.addEventListener('click', () => this.pasteFromClipboard());
        this.openBtn.addEventListener('click', () => this.openInBluesky());
        this.themeToggle.addEventListener('click', () => this.toggleTheme());
        
        const initialTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.dataset.theme = initialTheme;
        this.updateThemeIcon(initialTheme);
        
        const savedUrl = localStorage.getItem('lastBskyUrl');
        // Ne pas pré-remplir l'input au chargement
        // if (savedUrl) {
        //   this.postUrl.value = savedUrl;
        //   this.fetchPost();
        // }
        
        this.displayHistory();
      }

      handleInput() {
        const hasValue = this.postUrl.value.trim().length > 0;
        this.clearBtn.classList.toggle('hidden', !hasValue);
        
        if (this.postUrl.value.match(/profile\/([^/]+)\/post\/([^/]+)/)) {
          this.pulse(this.postUrl);
        }
        
        clearTimeout(this.debounceTimer);
        this.debounceTimer = setTimeout(() => {
          if (this.postUrl.value.trim()) {
            this.fetchPost();
          } else {
            this.clearOutput();
          }
        }, 800);
      }

      pulse(element) {
        element.style.animation = 'pulse 0.6s ease-in-out';
        setTimeout(() => {
          element.style.animation = '';
        }, 600);
      }

      clearInput() {
        this.postUrl.value = '';
        this.clearBtn.classList.add('hidden');
        this.clearOutput();
        localStorage.removeItem('lastBskyUrl');
        this.postUrl.focus();
      }

      clearOutput() {
        this.output.innerHTML = '';
        this.hideError();
      }

      showLoading() {
        this.output.innerHTML = this.renderShimmerPlaceholder();
        this.loading.classList.remove('hidden');
        this.hideError();
      }

      hideLoading() {
        this.loading.classList.add('hidden');
      }

      showError(message) {
        this.output.innerHTML = '';
        this.error.textContent = message;
        this.error.classList.remove('hidden');
      }

      hideError() {
        this.error.classList.add('hidden');
      }

      toggleTheme() {
        const root = document.documentElement;
        const next = root.dataset.theme === 'light' ? 'dark' : 'light';
        root.dataset.theme = next; 
        localStorage.setItem('theme', next);
        this.updateThemeIcon(next);
      }

      updateThemeIcon(theme) {
        this.themeIcon.textContent = theme === 'light' ? '☀️' : '🌙';
      }

      async pasteFromClipboard() {
        try { 
          const text = await navigator.clipboard.readText();
          if (text) { this.postUrl.value = text.trim(); this.handleInput(); }
        } catch (e) { this.showError('Clipboard not available. Please paste manually.'); }
      }

      openInBluesky() {
        const url = this.postUrl.value.trim();
        const match = url.match(/profile\/([^/]+)\/post\/([^/]+)/);
        if (match) window.open(url, '_blank');
        else this.showError('Provide a valid Bluesky post URL (e.g., https://bsky.app/profile/handle/post/rkey)');
      }

      async addToHistory(postData) {
        try {
          const response = await fetch('/api/v1/metadata/bskyHistory');
          let history = [];
          
          if (response.ok) {
            const data = await response.json();
            history = data.value || [];
          }
          
          const historyItem = {
            uri: postData.uri,
            handle: postData.author?.handle || 'unknown',
            displayName: postData.author?.displayName || 'Unknown',
            text: postData.record?.text?.substring(0, 100) + (postData.record?.text?.length > 100 ? '...' : '') || '',
            avatar: postData.author?.avatar || '',
            timestamp: new Date().toISOString()
          };
          
          history = history.filter(item => item.uri !== historyItem.uri);
          history.unshift(historyItem);
          history = history.slice(0, this.maxHistory);
          
          const saveResponse = await fetch('/api/v1/metadata/bskyHistory', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ value: history })
          });
          
          if (!saveResponse.ok) {
            throw new Error('Failed to save history via API');
          }
          
          this.displayHistory();
        } catch (err) {
          console.error('Failed to save to history via API, falling back to localStorage:', err);
          this.fallbackToLocalStorage(postData);
        }
      }

      fallbackToLocalStorage(postData) {
        let history = JSON.parse(localStorage.getItem('bskyHistory') || '[]');
        
        const historyItem = {
          uri: postData.uri,
          handle: postData.author?.handle || 'unknown',
          displayName: postData.author?.displayName || 'Unknown',
          text: postData.record?.text?.substring(0, 100) + (postData.record?.text?.length > 100 ? '...' : '') || '',
          avatar: postData.author?.avatar || '',
          timestamp: new Date().toISOString()
        };
        
        history = history.filter(item => item.uri !== historyItem.uri);
        history.unshift(historyItem);
        history = history.slice(0, this.maxHistory);
        
        localStorage.setItem('bskyHistory', JSON.stringify(history));
        this.displayHistory();
      }

      async displayHistory() {
        try {
          let history = [];
          const apiResponse = await fetch('/api/v1/metadata/bskyHistory');
          
          if (apiResponse.ok) {
            const data = await apiResponse.json();
            history = data.value || [];
          } else {
            history = JSON.parse(localStorage.getItem('bskyHistory') || '[]');
          }
          
          const existingHistory = document.getElementById('historyContainer');
          
          if (existingHistory) {
            existingHistory.style.opacity = '0';
            existingHistory.style.transform = 'translateY(-10px)';
            setTimeout(() => existingHistory.remove(), 300);
          }
          
          if (history.length === 0) return;
          
          const historyContainer = document.createElement('div');
          historyContainer.id = 'historyContainer';
          historyContainer.className = 'history-container';
          historyContainer.style.opacity = '0';
          historyContainer.style.transform = 'translateY(-10px)';
          historyContainer.style.transition = 'all 0.3s ease-out';
          
          const header = document.createElement('div');
          header.className = 'history-header';
          header.innerHTML = `
            <h3>Recently Viewed</h3>
            <button class="clear-history-btn" aria-label="Clear history">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
          `;
          header.querySelector('.clear-history-btn').addEventListener('click', async () => {
            try {
              await fetch('/api/v1/metadata/bskyHistory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: [] })
              });
            } catch (err) {
              console.error('Failed to clear history via API:', err);
            }
            localStorage.removeItem('bskyHistory');
            this.displayHistory();
          });
          historyContainer.appendChild(header);
          
          history.forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            const avatarHtml = item.avatar 
              ? `<img src="${item.avatar}" alt="${item.displayName}" onerror="this.onerror=null; this.closest('.history-avatar').innerHTML='<div class=&quot;history-avatar-fallback&quot;>${item.displayName.charAt(0).toUpperCase()}</div>'; this.closest('.history-avatar').querySelector('.history-avatar-fallback').style.display='flex';">`
              : `<div class="history-avatar-fallback">${item.displayName.charAt(0).toUpperCase()}</div>`;
            
            historyItem.innerHTML = `
              <div class="history-avatar">
                ${avatarHtml}
              </div>
              <div class="history-content">
                <div class="history-name">${item.displayName}</div>
                <div class="history-handle">@${item.handle}</div>
                <div class="history-text">${item.text}</div>
              </div>
            `;
            
            historyItem.addEventListener('click', () => {
              const url = `https://bsky.app/profile/${item.handle}/post/${item.uri.split('/').pop()}`;
              this.postUrl.value = url;
              this.fetchPost();
            });
            
            historyContainer.appendChild(historyItem);
          });
          
          document.querySelector('.container').appendChild(historyContainer);
          
          requestAnimationFrame(() => {
            historyContainer.style.opacity = '1';
            historyContainer.style.transform = 'translateY(0)';
          });
        } catch (err) {
          console.error('Failed to display history:', err);
        }
      }

      async fetchPost() {
        const urlInput = this.postUrl.value.trim();
        if (!urlInput) {
          this.clearOutput();
          return;
        }

        localStorage.setItem('lastBskyUrl', urlInput);

        this.showLoading();

        const match = urlInput.match(/profile\/([^/]+)\/post\/([^/]+)/);
        if (!match) {
          this.showError('Invalid URL format. Please use: https://bsky.app/profile/handle/post/rkey');
          this.hideLoading();
          return;
        }

        const [_, handle, rkey] = match;
        const postUri = `at://${handle}/app.bsky.feed.post/${rkey}`;
        const apiUrl = `https://public.api.bsky.app/xrpc/app.bsky.feed.getPostThread?uri=${postUri}&depth=0`;

        try {
          const res = await fetch(apiUrl);
          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`Failed to fetch post: ${res.status} ${res.statusText} - ${errorText}`);
          }
          
          const data = await res.json();
          this.renderPost(data);
          
          if (data.thread?.post) {
            setTimeout(() => {
              this.addToHistory(data.thread.post);
            }, 300);
          }
        } catch (err) {
          this.showError(`Error: ${err.message}. Please check the URL and try again.`);
        } finally {
          this.hideLoading();
        }
      }

      renderShimmerPlaceholder() {
        return `
          <div class="shimmer-post-card shimmer">
            <div class="shimmer-header">
              <div class="shimmer-avatar shimmer-placeholder"></div>
              <div class="shimmer-info">
                <div class="shimmer-name shimmer-placeholder"></div>
                <div class="shimmer-handle shimmer-placeholder"></div>
              </div>
            </div>
            <div class="shimmer-content">
              <div class="shimmer-line shimmer-placeholder"></div>
              <div class="shimmer-line shimmer-placeholder"></div>
              <div class="shimmer-line shimmer-placeholder"></div>
            </div>
            <div class="shimmer-media">
              <div class="shimmer-media-item shimmer-placeholder"></div>
              <div class="shimmer-media-item shimmer-placeholder"></div>
            </div>
            <div class="shimmer-stats">
              <div class="shimmer-stat shimmer-placeholder"></div>
              <div class="shimmer-stat shimmer-placeholder"></div>
              <div class="shimmer-stat shimmer-placeholder"></div>
            </div>
          </div>
        `;
      }

      renderPost(data) {
        this.output.innerHTML = '';
        
        if (!data.thread || !data.thread.post) {
          this.showError('No post found for this URL.');
          return;
        }

        const post = data.thread.post;
        const author = post.author || {};
        const record = post.record || {};

        const postCard = document.createElement('div');
        postCard.className = 'post-card';

        const header = this.createPostHeader(author, post.indexedAt);
        postCard.appendChild(header);

        const content = this.createPostContent(record.text);
        postCard.appendChild(content);

        if (post.embed && (post.embed.images || post.embed.video)) {
          const media = this.createPostMedia(post.embed);
          if (media) postCard.appendChild(media);
        }

        const stats = this.createPostStats(post);
        postCard.appendChild(stats);

        this.output.appendChild(postCard);
        
        this.fadeIn(postCard, 600);
      }

      createPostHeader(author, indexedAt) {
        const header = document.createElement('div');
        header.className = 'post-header';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        
        const profileUrl = author.handle ? `https://bsky.app/profile/${author.handle}` : '#';
        let avatarContent = `<a href="${profileUrl}" target="_blank" rel="noopener" aria-label="View ${author.displayName || 'Unknown'}'s profile">`;

        if (author.avatar) {
          avatarContent += `<img src="${author.avatar}" alt="${author.displayName || 'Avatar'}" onerror="this.onerror=null; this.closest('.avatar').innerHTML='<a href=&quot;${profileUrl}&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot; aria-label=&quot;View ${author.displayName || 'Unknown'}'s profile&quot;><div style=&quot;display:flex; align-items:center; justify-content:center; width:100%; height:100%;&quot;>${author.displayName?.charAt(0).toUpperCase() || '@'}</div></a>';">`;
        } else {
          avatarContent += `<div style="display:flex; align-items:center; justify-content:center; width:100%; height:100%;">` + (author.displayName?.charAt(0).toUpperCase() || '@') + `</div>`;
        }
        avatarContent += `</a>`;
        avatar.innerHTML = avatarContent;

        const info = document.createElement('div');
        info.className = 'post-info';

        const name = document.createElement('div');
        name.className = 'display-name';
        name.innerHTML = `<a href="${profileUrl}" target="_blank" rel="noopener" style="color:inherit; text-decoration:none;">${author.displayName || 'Unknown'}</a>`;

        const handle = document.createElement('div');
        handle.className = 'handle';
        handle.innerHTML = `<a href="${profileUrl}" target="_blank" rel="noopener" style="color:var(--subtle); text-decoration:none;">@${author.handle || 'unknown'}</a>`;

        info.appendChild(name);
        info.appendChild(handle);

        const time = document.createElement('div');
        time.className = 'post-time';
        time.textContent = this.formatTime(indexedAt);

        header.appendChild(avatar);
        header.appendChild(info);
        header.appendChild(time);

        return header;
      }

      createPostContent(text) {
        const content = document.createElement('div');
        content.className = 'post-content';
        
        const parsedText = this.parseFacets(text || '');
        content.innerHTML = parsedText;
        
        return content;
      }

      parseFacets(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      }

      createPostMedia(embed) {
        if (!embed || (!embed.images && !embed.video)) return null;

        const mediaContainer = document.createElement('div');
        mediaContainer.className = 'post-media';

        if (embed.images) {
          embed.images.forEach(img => {
            const imgEl = document.createElement('img');
            imgEl.src = img.fullsize || img.thumb;
            imgEl.alt = img.alt || 'Post image';
            imgEl.loading = 'lazy';
            imgEl.addEventListener('click', () => this.openModal(img.fullsize || img.thumb));
            mediaContainer.appendChild(imgEl);
          });
        }

        if (embed.video) {
          const video = document.createElement('video');
          video.src = embed.video.fullsize;
          video.controls = true;
          video.preload = 'metadata';
          mediaContainer.appendChild(video);
        }

        return mediaContainer;
      }

      createPostStats(post) {
        const stats = document.createElement('div');
        stats.className = 'post-stats';

        const statsData = [
          { label: 'likes', value: post.likeCount || 0, iconSvg: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-heart"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>' },
          { label: 'reposts', value: post.repostCount || 0, iconSvg: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-repeat"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>' },
          { label: 'replies', value: post.replyCount || 0, iconSvg: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-message-square"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>' }
        ];

        statsData.forEach(stat => {
          const statEl = document.createElement('div');
          statEl.className = 'stat';
          statEl.innerHTML = `
            ${stat.iconSvg}
            <span>${this.formatNumber(stat.value)}</span>
          `;
          stats.appendChild(statEl);
        });

        return stats;
      }

      openModal(src) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `<img src="${src}" alt="Full size image">`;
        modal.addEventListener('click', () => {
          modal.style.animation = 'fadeOut 0.3s ease forwards';
          modal.querySelector('img').style.animation = 'zoomOut 0.3s ease forwards';
          setTimeout(() => modal.remove(), 300);
        });
        document.body.appendChild(modal);
      }

      formatTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(minutes / (60 * 24));
        const weeks = Math.floor(days / 7);
        const months = Math.floor(days / 30);
        const years = Math.floor(days / 365);
        
        if (seconds < 60) return `${seconds}s`;
        if (minutes < 60) return `${minutes}m`;
        if (hours < 24) return `${hours}h`;
        if (days < 7) return `${days}d`;
        if (weeks < 4) return `${weeks}w`;
        if (months < 12) return `${months}mo`;
        return `${years}y`;
      }

      formatNumber(num) {
        if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
      }

      fadeIn(element, duration = 300) {
        element.style.opacity = '0';
        element.style.transform = 'translateY(20px)';
        element.style.transition = `all ${duration}ms ease-out`;
        
        requestAnimationFrame(() => {
          element.style.opacity = '1';
          element.style.transform = 'translateY(0)';
        });
      }
    }

    new BlueskyViewer();
  </script>
</body>
</html>